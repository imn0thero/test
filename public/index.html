<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat Room</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="chat-container">
    <header>
      <h2>Web Chat</h2>
      <div class="status">
        <span id="onlineStatus">Online Users:</span>
        <span id="lastSeen"></span>
      </div>
      <div class="actions">
        <form action="/logout" method="POST" id="logoutForm">
          <input type="hidden" name="username" id="logoutUsername" />
          <button type="submit">Logout</button>
        </form>
        <button id="deleteAllBtn">Hapus Semua Pesan</button>
      </div>
    </header>

    <main id="chatBox"></main>

    <form id="messageForm" enctype="multipart/form-data">
      <input type="hidden" name="sender" id="sender" />
      <input type="text" name="text" placeholder="Ketik pesan..." required />
      <input type="file" name="media" accept="image/*,video/*" />
      <button type="submit">Kirim</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const username = urlParams.get('user');
    if (!username) window.location.href = '/login.html';

    document.getElementById('sender').value = username;
    document.getElementById('logoutUsername').value = username;

    const socket = io();
    socket.emit('userOnline', username);

    const chatBox = document.getElementById('chatBox');

    function renderMessage(msg) {
      const div = document.createElement('div');
      div.className = 'message ' + (msg.sender === username ? 'me' : 'other');
      div.innerHTML = `
        <p><strong>${msg.sender}</strong></p>
        <p>${msg.text || ''}</p>
        ${msg.media ? `<img src="${msg.media}" class="media" />` : ''}
        <small>${new Date(msg.timestamp).toLocaleString()}</small>
      `;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    fetch('/messages')
      .then(res => res.json())
      .then(data => data.forEach(renderMessage));

    socket.on('newMessage', renderMessage);

    socket.on('clearMessages', () => {
      chatBox.innerHTML = '';
    });

    socket.on('updateStatus', (sessions) => {
      let text = Object.keys(sessions).join(', ') || 'Tidak ada user online';
      document.getElementById('onlineStatus').textContent = 'Online Users: ' + text;
    });

    document.getElementById('messageForm').addEventListener('submit', async e => {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      await fetch('/message', { method: 'POST', body: data });
      form.reset();
    });

    document.getElementById('deleteAllBtn').onclick = () => {
      fetch('/deleteAll', { method: 'POST' });
    };
  </script>
</body>
</html>
